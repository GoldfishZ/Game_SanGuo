# 游戏主流程实现总结

## 概述

成功实现了三国武将卡牌游戏的完整主流程，包括选将、抛骰子决定先手、回合制战斗等核心功能。

## 🎮 主流程功能

### 1. 游戏入口 (main.py)

- **主菜单系统**:

  - 开始游戏
  - 武将图鉴
  - 交互式武将图鉴
  - 游戏说明
  - 退出游戏

- **流程控制**: 整合了新的游戏流程控制器，替代原有的 GUI 界面

### 2. 游戏流程控制器 (GameFlowController)

#### 核心组件

- **GamePhase**: 游戏阶段枚举

  - MENU (主菜单)
  - GENERAL_SELECTION (选将阶段)
  - DICE_ROLL (抛骰子决定先手)
  - BATTLE (战斗阶段)
  - SKILL_PHASE (技能使用阶段)
  - ATTACK_PHASE (普攻阶段)
  - GAME_OVER (游戏结束)

- **Player**: 玩家类
  - 管理玩家 ID、姓名、队伍
  - 选中的武将列表
  - 败北判定方法

#### 主要流程

### 3. 🎲 选将阶段

```python
def _enter_general_selection(self):
    """进入选将阶段"""
    # 1. 生成15位武将的选择池
    self._generate_general_pool()

    # 2. 显示武将池
    self._display_general_pool()

    # 3. 玩家1选将
    self._player_select_generals(self.player1)

    # 4. 玩家2选将
    self._player_select_generals(self.player2)
```

**特点**:

- 从现有武将库随机生成 15 位武将
- 支持重复武将（增加策略性）
- 交互式选将，可以选择多位武将
- 实时显示选择状态

### 4. 🎯 抛骰子决定先手

```python
def _roll_dice_for_first_player(self):
    """抛骰子决定先手玩家"""
    dice1 = random.randint(1, 6)
    dice2 = random.randint(1, 6)

    # 平局则重新抛骰子
    if dice1 == dice2:
        self._roll_dice_for_first_player()
```

**特点**:

- 1-6 点随机骰子
- 平局自动重新抛骰子
- 确定先手玩家和初始回合顺序

### 5. ⚔️ 回合制战斗系统

#### 回合顺序规则

```
第1回合: 先手玩家
第2回合: 后手玩家
第3回合: 后手玩家 (连续2回合)
第4回合: 先手玩家 (开始交替)
第5回合: 后手玩家
第6回合: 先手玩家
...继续交替
```

#### 每回合结构

```python
def _execute_turn(self):
    """执行一个回合"""
    # 1. 显示当前状态
    self._display_battle_status()

    # 2. 技能使用阶段
    self._execute_skill_phase()

    # 3. 普攻阶段
    self._execute_attack_phase()

    # 4. 检查游戏结束
    if self._is_game_over():
        return

    # 5. 切换到下一个玩家
    self._switch_to_next_player()
```

### 6. ✨ 技能使用阶段

**功能**:

- 显示当前玩家存活武将
- 显示每个武将的技能状态（冷却时间、是否可用）
- 玩家选择武将使用技能
- 根据技能类型自动选择目标
- 显示技能使用结果

**技能目标类型支持**:

- `SELF`: 对自己使用
- `ALL_ALLIES`: 对己方全体使用
- `SINGLE_ENEMY`: 对单个敌人使用（玩家选择目标）

### 7. ⚔️ 普攻阶段

**功能**:

- 选择攻击的武将
- 选择攻击目标
- 考虑伏兵等被动技能的目标选择限制
- 执行攻击并显示结果
- 处理武将阵亡

### 8. 🏆 游戏结束判定

**条件**: 某一方所有武将全部阵亡

**处理**:

- 显示胜负结果
- 统计游戏数据（总回合数、先手玩家等）
- 游戏状态切换到 GAME_OVER

## 🔧 技术特点

### 1. 战斗上下文 (BattleContext)

```python
class BattleContext:
    """战斗上下文，为技能提供必要信息"""

    def get_team_for_general(self, general: General) -> Team:
        """根据武将获取所属队伍"""
        # 支持技能系统获取队伍信息
```

**用途**:

- 为技能系统提供战斗环境信息
- 支持同盟缔结等队伍级别技能
- 连接武将和队伍的桥梁

### 2. 模块化设计

- **独立的游戏阶段**: 每个阶段有明确的职责
- **可扩展的玩家系统**: 支持将来扩展为多人游戏
- **灵活的技能系统**: 集成现有的主动/被动技能
- **清晰的状态管理**: 游戏状态、回合状态、武将状态

### 3. 错误处理

- 输入验证和错误提示
- 异常状态的自动恢复
- 用户友好的错误信息

## 📊 测试验证

### 自动化测试 (test_game_flow.py)

```python
✅ 武将池生成：15位随机武将
✅ 选将流程：玩家选择武将加入队伍
✅ 抛骰子：决定先手玩家
✅ 回合制：先手1回合，后手2回合，然后交替
✅ 战斗阶段：技能使用 → 普攻
✅ 游戏结束：全军覆没判定
```

### 测试结果

```
🎮 游戏主流程测试
============================================================
📋 测试武将池生成...
✅ 已生成包含15位武将的选择池

🎯 模拟玩家选将...
👥 队伍总览 - 玩家1: 金环三结, 张任 | 玩家2: 张任, 鲁肃

🎲 测试抛骰子决定先手...
🎯 玩家1 点数更大，获得先手！

⚔️ 测试战斗回合...
💀 金环三结 已阵亡！

🔄 测试回合切换逻辑...
✅ 回合切换逻辑正确！
```

## 🎯 游戏体验

### 1. 策略深度

- **选将策略**: 从 15 位武将中选择最优组合
- **技能时机**: 何时使用技能，保留士气
- **攻击目标**: 优先攻击哪个敌方武将
- **被动技能**: 伏兵、防栅等影响目标选择

### 2. 随机要素

- **武将池**: 每局游戏都有不同的可选武将
- **抛骰子**: 先手优势的随机性
- **技能判定**: 勇猛、魅力等技能的判定系统（预留）

### 3. 交互体验

- **清晰的信息显示**: 武将状态、技能冷却、士气等
- **直观的选择界面**: 编号选择，错误提示
- **实时反馈**: 攻击结果、技能效果立即显示

## 🚀 未来扩展

### 1. AI 玩家

- 实现电脑玩家的决策算法
- 不同难度的 AI 策略

### 2. 更多武将

- 扩展武将库到 30+位武将
- 更多样的技能组合

### 3. 高级战斗功能

- 阵型系统
- 装备系统
- 特殊胜利条件

### 4. 多人游戏

- 支持 3-4 人对战
- 联盟机制

## 总结

游戏主流程已经完整实现，提供了：

✅ **完整的游戏循环**: 从选将到战斗结束  
✅ **平衡的回合制**: 公平的先手后手机制  
✅ **丰富的策略性**: 武将选择、技能使用、攻击决策  
✅ **稳定的系统**: 全面的测试覆盖和错误处理  
✅ **良好的扩展性**: 模块化设计，便于添加新功能

现在玩家可以体验完整的三国武将卡牌游戏，从选将策略到战斗执行，享受策略对战的乐趣！🎮
